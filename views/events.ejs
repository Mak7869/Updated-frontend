<% layout('layouts/boilerplate') -%>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="display-4 fw-bold">
    ğŸ“… Events Dashboard
  </h1>

  <% if(user && user.ROLE === 'organizer') { %>
  <a href="/events/new" class="btn btn-indigo">
    â• Add New Event
  </a>
  <% } %>
</div>

<!-- Search and Filter Form -->
<div class="search-filter-box">
  <form method="GET" action="/events">
    <div class="row g-3">
      <!-- Search Input -->
      <div class="col-md-6">
        <label for="search" class="form-label fw-semibold">ğŸ” Search Events</label>
        <input
          type="text"
          name="search"
          id="search"
          value="<%= searchQuery %>"
          placeholder="Search by event name or description..."
          class="form-control"
        />
      </div>

      <!-- Filter Options -->
      <div class="col-md-3">
        <label class="form-label fw-semibold">ğŸ“… Filter by Date</label>
        <div class="d-flex flex-column gap-2">
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="filter"
              id="all"
              value=""
              <%= activeFilter === '' ? 'checked' : '' %>
            />
            <label class="form-check-label" for="all">
              All Events
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="filter"
              id="upcoming"
              value="upcoming"
              <%= activeFilter === 'upcoming' ? 'checked' : '' %>
            />
            <label class="form-check-label" for="upcoming">
              Upcoming
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="filter"
              id="past"
              value="past"
              <%= activeFilter === 'past' ? 'checked' : '' %>
            />
            <label class="form-check-label" for="past">
              Past
            </label>
          </div>
        </div>
      </div>

      <!-- Category Filter -->
      <div class="col-md-2">
        <label class="form-label fw-semibold">ğŸ·ï¸ Category</label>
        <select name="category" class="form-select">
          <option value="">All Categories</option>
          <option value="1" <%= activeCategory == '1' ? 'selected' : '' %>>Workshop</option>
          <option value="2" <%= activeCategory == '2' ? 'selected' : '' %>>Seminar</option>
          <option value="3" <%= activeCategory == '3' ? 'selected' : '' %>>Meetup</option>
          <option value="4" <%= activeCategory == '4' ? 'selected' : '' %>>Concert</option>
          <option value="5" <%= activeCategory == '5' ? 'selected' : '' %>>Conference</option>
          <option value="6" <%= activeCategory == '6' ? 'selected' : '' %>>Webinar</option>
          <option value="7" <%= activeCategory == '7' ? 'selected' : '' %>>Exhibition</option>
          <option value="8" <%= activeCategory == '8' ? 'selected' : '' %>>Sports</option>
          <option value="9" <%= activeCategory == '9' ? 'selected' : '' %>>Wedding</option>
          <option value="10" <%= activeCategory == '10' ? 'selected' : '' %>>Birthday</option>
        </select>
      </div>

      <!-- Sort Order -->
      <div class="col-md-2">
        <label class="form-label fw-semibold">ğŸ“ˆ Sort Order</label>
        <select name="sort" class="form-select">
          <option value="asc" <%= activeSort === 'asc' ? 'selected' : '' %>>ğŸ“… Oldest First</option>
          <option value="desc" <%= activeSort === 'desc' ? 'selected' : '' %>>ğŸ“… Newest First</option>
        </select>
      </div>

    <!-- Buttons -->
    <div class="col-md-2 d-flex align-items-end gap-2">
      <button type="submit" class="btn btn-primary flex-fill" data-bs-toggle="tooltip" title="Apply search and filters">
        ğŸ” Search
      </button>
      <a href="/events" class="btn btn-secondary flex-fill" data-bs-toggle="tooltip" title="Reset all filters">
        ğŸ”„ Reset
      </a>
    </div>
    </div>

    <!-- Clear Filters Link -->
    <% if(searchQuery || activeFilter) { %>
    <div class="mt-2">
      <a href="/events" class="text-decoration-none">
        <small class="text-muted">âŒ Clear all filters</small>
      </a>
    </div>
    <% } %>
  </form>
</div>

<!-- Event List Container -->
<div class="event-list-container">
  <table class="table table-hover mb-0">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Date</th>
          <th>Location</th>
          <th>Description</th>
          <th>Category & Tags</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

    <tbody>
      <% events.forEach(event => { %> <% const isAttending = attendingEvents.includes(event.EVENT_ID); %> <% const isOrganizer = user && event.ORGANIZER_ID === user.USER_ID; %>

      <tr>
        <td><%= event.EVENT_ID %></td>
        <td><%= event.EVENT_NAME %></td>

        <td>
          <%= event.EVENT_DATE ? new Date(event.EVENT_DATE).toISOString().slice(0,16).replace("T", " ") : "N/A" %>
        </td>

        <td><%= event.LOCATION %></td>
        <td><%= event.DESCRIPTION %></td>

        <td>
          <% if(event.CATEGORY_NAME) { %>
            <span class="badge bg-primary me-1"><%= event.CATEGORY_NAME %></span>
          <% } %>
          <% if(event.TAGS) { %>
            <% event.TAGS.split(',').forEach(tag => { %>
              <span class="badge bg-info me-1"><%= tag %></span>
            <% }) %>
          <% } %>
        </td>

        <td>
          <% if(event.STATUS === 'draft') { %>
            <span class="badge bg-secondary">Draft</span>
          <% } else if(event.STATUS === 'published') { %>
            <span class="badge bg-success">Published</span>
          <% } else if(event.STATUS === 'cancelled') { %>
            <span class="badge bg-danger">Cancelled</span>
          <% } %>
        </td>

        <td>
          <% if(isOrganizer) { %>

          <!-- Status Management -->
          <% if(event.STATUS === 'draft') { %>
            <form action="/events/<%= event.EVENT_ID %>/publish" method="POST" class="d-inline me-1">
              <button type="submit" class="btn btn-sm btn-success" title="Publish Event">
                ğŸ“¢ Publish
              </button>
            </form>
          <% } else if(event.STATUS === 'published') { %>
            <form action="/events/<%= event.EVENT_ID %>/unpublish" method="POST" class="d-inline me-1">
              <button type="submit" class="btn btn-sm btn-warning" title="Unpublish Event">
                ğŸ“ Unpublish
              </button>
            </form>
            <form action="/events/<%= event.EVENT_ID %>/cancel" method="POST" class="d-inline me-1" onsubmit="return confirm('Are you sure you want to cancel this event?')">
              <button type="submit" class="btn btn-sm btn-danger" title="Cancel Event">
                âŒ Cancel
              </button>
            </form>
          <% } else if(event.STATUS === 'cancelled') { %>
            <form action="/events/<%= event.EVENT_ID %>/publish" method="POST" class="d-inline me-1">
              <button type="submit" class="btn btn-sm btn-success" title="Re-publish Event">
                ğŸ”„ Re-publish
              </button>
            </form>
          <% } %>

          <!-- Edit -->
          <a href="/events/<%= event.EVENT_ID %>/edit" class="btn btn-sm btn-primary me-1">
            Edit
          </a>

          <!-- View Attendees -->
          <a href="/events/<%= event.EVENT_ID %>/attendees" class="btn btn-sm btn-secondary me-1">
            Attendees
          </a>

          <!-- Delete -->
          <form action="/events/<%= event.EVENT_ID %>?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Delete this event?')">
            <button class="btn btn-sm btn-danger">
              Delete
            </button>
          </form>

          <% } else if(user && user.ROLE === 'attendee') { %> <%
          if(isAttending) { %>
          <!-- Leave Event -->
          <form action="/events/<%= event.EVENT_ID %>/leave" method="POST" class="d-inline" onsubmit="return confirm('Leave this event?')">
            <button class="btn btn-sm btn-warning">
              Leave Event
            </button>
          </form>

          <% } else { %>

          <!-- Join -->
          <a href="/events/<%= event.EVENT_ID %>/join" class="btn btn-sm btn-success">
            Join Event
          </a>

          <% } %> <% } %>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>
